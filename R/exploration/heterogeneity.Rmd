# Investigating heterogeneity within perturbations and between them

```{r}
# Set libpaths
.libPaths(c("/raleighlab/data1/czou/gbm_perturb/gbm_perturb/renv/library/R-4.3/x86_64-pc-linux-gnu", .libPaths()))
```

Import libraries

```{r}
library(Seurat)
library(clusterProfiler)
library(org.Hs.eg.db)
library(knitr)
library(msigdbr)
library(fgsea)
library(dplyr)
library(data.table)
library(ggplot2)
library(grid)
library(patchwork)
library(scales)
library(reshape2)
library(SCpubr)
library(enrichR)
library(RColorBrewer)
```

Define some constants. Note that we are using the human and mouse combined reference Seurat object right now.

```{r}
OUTPUT_DIR <- "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity"
PATH_TO_SEURAT_OBJECT <- "/raleighlab/data1/liuj/gbm_perturb/analysis/GBM43_1_malignant_only_annotated_20230817.Rds"
```

## Mixscape

Load up the R object and run basic workflow on it. Note that we remove the following perturbations:

-   GRAMD4, which bad knockdown of GRAMD4 and potential off-target effects with genes like PARP3

-   FBXL16, bad knockdown

-   OVCH1, bad knockdown

```{r}
data <- readRDS(PATH_TO_SEURAT_OBJECT)
off_targets <- c("GRAMD4", "FBXL16", "OVCH1")
include_genes <- setdiff(unique(data$sgRNA), off_targets)
data <- subset(data, sgRNA %in% include_genes)

data <- NormalizeData(object = data, assay = "RNA", normalization.method = "CLR", margin = 2)
DefaultAssay(object = data) <- "RNA"

data <- NormalizeData(object = data) %>% FindVariableFeatures() %>% ScaleData()
data <- RunPCA(object = data)

ElbowPlot(data, ndims = 50)
data <- RunUMAP(object = data, dims = 1:40)
```

Now get cell cycle scores.

```{r}
s.genes <- paste("GRCh38-", cc.genes$s.genes, sep = "")
g2m.genes <- paste("GRCh38-", cc.genes$g2m.genes, sep = "")
data <- CellCycleScoring(data, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

# Plot the entire set of data, split by RT
plot <- DimPlot(object = data, group.by = 'Phase', split.by = "cond", reduction = "umap", ncol = 1, pt.size = 3, label = TRUE, label.box = TRUE, label.color = "white")
plot1 <- DimPlot(object = data, group.by = 'sgRNA', split.by = "cond", reduction = "umap", ncol = 1, pt.size = 3, label = TRUE, label.box = TRUE, label.color = "white")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/umap_cellcycle.png", plot | plot1, width = 40, height = 20)

# Plot data for individual perturbations and show them across cell cycle
for (i in c("non-targeting", "PRKDC", "CENPT")) {
  perturb_data = subset(data, sgRNA == i)
  perturb_cells = colnames(perturb_data)
  plot <- DimPlot(object = data, group.by = 'Phase', split.by = "cond", reduction = "umap",
                  ncol = 1, pt.size = 3)
  plot1 <- DimPlot(object = data, group.by = 'sgRNA', split.by = "cond", reduction = "umap",
                   ncol = 1, cells.highlight = perturb_cells, pt.size = 3)
  ggsave(sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/umap_cellcycle_highlight_%s.png", i), plot | plot1, width = 40,
         height = 20)
}
```

Interesting...so we see that there is a great deal of heterogeneity across cell cycle across these two perturbations.

```{r}
data <- CalcPerturbSig(
  object = data,
  assay = "RNA",
  slot = "data",
  gd.class = "sgRNA",
  nt.cell.class = "non-targeting",
  reduction = "pca",
  ndims = 50,
  num.neighbors = 30,
  new.assay.name = "PRTB",
  split.by = "cond"
)
DefaultAssay(data) <- "PRTB"

VariableFeatures(data) <- VariableFeatures(data[["RNA"]])
data <- ScaleData(data, do.scale = FALSE, do.center = TRUE)

data <- RunPCA(object = data, reduction.key = "prtbpca", reduction.name = "prtbpca")

data <- RunUMAP(
  object = data, 
  dims = 1:50, 
  reduction = 'prtbpca', 
  reduction.key = 'prtbumap', 
  reduction.name = 'prtbumap')
```

Now let's plot after normalization.

```{r}
plot <- DimPlot(object = data, group.by = 'Phase', pt.size = 2, split.by = "cond", reduction = "prtbumap", ncol = 1) 
plot1 <- DimPlot(object = data, group.by = 'sgRNA', pt.size = 2, split.by = "cond", reduction = "prtbumap", ncol = 1, label = TRUE, label.box = TRUE, label.color = "white")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/umap_prtb_cellcycle.png", plot | plot1, width = 40, height = 20)
```

Run Mixscape, splitting by radiation condition:

```{r}
data <- RunMixscape(
  object = data,
  assay = "PRTB",
  slot = "scale.data",
  labels = "sgRNA",
  nt.class.name = "non-targeting",
  min.de.genes = 5,
  logfc.threshold = 0.1,
  iter.num = 10,
  de.assay = "RNA",
  verbose = TRUE,
  prtb.type = "KO",
  split.by = "cond"
)

df <- table(data$mixscape_class.global, data$mixscape_class)
df2 <- reshape2::melt(df)
df2$Var2 <- as.character(df2$Var2)
test <- df2[which(df2$Var1 == "KO"),]
test <- test[order(test$value, decreasing = TRUE),]
new.levels <- test$Var2
df2$Var2 <- factor(df2$Var2, levels = new.levels )
df2$Var1 <- factor(df2$Var1, levels = c("non-targeting", "NP", "KO"))
df2$gene <- sapply(as.character(df2$Var2), function(x) strsplit(x, split = " ")[[1]][1])
df3 <- df2[-c(which(df2$gene == "non-targeting")),]

p1 <- ggplot(df3, aes(x = gene, y = value, fill= Var1)) +
  geom_bar(stat= "identity") +
  theme_classic()+
  scale_fill_manual(values = c("grey49", "grey79","coral1")) + 
  ylab("n cells") +
  xlab("sgRNA")

plot <- p1 + theme(axis.text.x = element_blank(),
           axis.text.y = element_text(size = 10), 
           axis.title = element_text(size = 8), 
           strip.text = element_text(size=8, face = "bold")) + 
  facet_wrap(vars(gene),ncol = 5, scales = "free") +
  labs(fill = "mixscape class") +theme(legend.title = element_text(size = 10),
                                       legend.text = element_text(size = 8))

ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/mixscape_prtb_ncell_calls.png", plot, width = 12, height = 8)

saveRDS(data, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/mixscaped_data.rds")
```

Inspect the MixScape results. Can we tell what's going on with certain clusters?

```{r}
perturb_plot <- PlotPerturbScore(object = data, target.gene.ident = "PRKDC", target.gene.class = "sgRNA", mixscape.class = "mixscape_class", col = "coral2", split.by = "cond") + labs(fill = "mixscape class")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/prkdc_perturb_plot.png", perturb_plot, width = 12, height = 8)

# For remaining plots, split by RT and noRT

for (condition in c("noRT", "RT")) {
  cond_object = subset(data, cond == condition)
  vln_plot <- VlnPlot(cond_object, "mixscape_class_p_ko", idents = c("non-targeting", "PRKDC KO", "PRKDC NP")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), 
        axis.text = element_text(size = 16), 
        plot.title = element_text(size = 20)) + 
  NoLegend() +
  ggtitle("mixscape posterior probabilities")
  ggsave(sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/prkdc_vln_plot_%s.png", condition), vln_plot, width = 12,
         height = 8)
  
  Idents(object = cond_object) <- "sgRNA"
  genepass <- c('PRKDC','CENPT','RBX1')

  for (i in 1:length(genepass)) {
    plot <- MixscapeHeatmap(object = cond_object, 
                            ident.1 = "non-targeting", 
                            ident.2 = genepass[i], 
                            balanced = FALSE, 
                            assay = "RNA", 
                            max.genes = 30, angle = 0, 
                            group.by = "mixscape_class", 
                            max.cells.group = 300,
                            size=6.5) + NoLegend() + 
      theme(axis.text.y = element_text(size = 16))
      ggsave(paste("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/de_genes/mixscape_prtb_",genepass[i],condition,"_DEgenes.png", sep=''),
             plot, width = 15, height = 10)
  }
}
```

Run Linear Discriminant Analysis, splitting by radiation condition again.

```{r}
for (condition in c("noRT", "RT")) {
  cond_object = subset(data, cond == condition)
  cond_object <- MixscapeLDA(
    object = cond_object,
    assay = "RNA",
    pc.assay = "PRTB",
    labels = "sgRNA",
    nt.label = "non-targeting",
    npcs = 10,
    logfc.threshold = 0.1,
    verbose = TRUE
  )
  
  cond_object <- RunUMAP(
    object = cond_object,
    dims = 1:30,
    reduction = 'lda',
    reduction.key = 'ldaumap',
    reduction.name = 'ldaumap'
  )
  
  plot <- DimPlot(object = cond_object, group.by = 'Phase', pt.size = 1, 
                reduction = "ldaumap", ncol = 1) 
  plot1 <- DimPlot(object = cond_object, group.by = 'sgRNA', pt.size = 1, 
               reduction = "ldaumap", ncol = 1,
               label = TRUE, label.box = TRUE, label.color = "white") 
  ggsave(sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/mixscape_prtb_LDAumap_%s.png", condition), 
         plot | plot1, width = 30, height = 20, limitsize = FALSE)
  
  iter = names(table(cond_object$sgRNA))
  for (i in 1:length(table(cond_object$sgRNA))){
    plot <- DimPlot(object = cond_object, group.by = 'sgRNA', 
                    pt.size = 1, reduction = "ldaumap",
                    ncol = 1,
                    cells.highlight = colnames(cond_object)[cond_object$sgRNA == iter[i]]) +
      NoLegend() + ggtitle(iter[i])
    ggsave(paste("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/highlight/mixscape_prtb_LDAumap_",
                 iter[i], condition, ".png", sep=''), plot, width = 10, height = 8)
  }

  # Make custom plot highlighting only select genes
  genepass <- c('PRKDC','CENPT','RBX1','non-targeting')
  cond_object$sgRNAPass <- cond_object$sgRNA
  cond_object$sgRNAPass[!(cond_object$sgRNAPass %in% genepass)] = 'Other'

  # cell cycle vs select sgRNAs
  # Set colors for each perturbation.
  col = brewer.pal(n = 4, name = "Dark2")
  col = c(col[1:2],'gray80','gray90',col[3:4])

  Idents(object = cond_object) <- "sgRNAPass"
  plot <- DimPlot(object = cond_object, group.by = 'Phase', pt.size = 3, 
                reduction = "ldaumap", ncol = 1) 
  plot1 <- DimPlot(object = cond_object, group.by = 'sgRNAPass', pt.size = 3, 
                   reduction = "ldaumap", ncol = 1) + scale_color_manual(values=col, 
                                                                         drop=FALSE) 
  ggsave(sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/mixscape_prtb_LDAumap_passgenes_%s.png", condition), 
         plot | plot1, width = 30, height = 20, limitsize = FALSE)

  # cluster sgRNAs by perturbation 
  cond_object.PRTB <- AverageExpression(cond_object, assay = "PRTB", 
                                 slot = 'scale.data', group.by = "sgRNA")
  corsPRTB <- cor(cond_object.PRTB$PRTB)

  png(sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/heatmap_PRTB_scaledata_averageExpr_%s.png",
              condition), width = 6000, height=6000,res = 600)
  heatmap(corsPRTB)
  saveRDS(cond_object, file = sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/%s_data.rds", condition))
}
```

Make a highlight plot with only the genes we're interested in.

```{r}
genes.of.interest <- c("PRKDC", "RBX1", "RPLP0", "RBM42", "POLR2C", "MED17", "non-targeting")

cond.objects <- list()
cond.objects[["noRT"]] <- cond.object.noRT
cond.objects[["RT"]] <- cond.object.RT
num_colors <- length(genes.of.interest) - 1
dark2_colors <- brewer.pal(num_colors, "Dark2")


for (condition in c("noRT", "RT")) {
  cond.object <- cond.objects[[condition]]
  cond.object$sgRNA <- factor(cond.object$sgRNA, levels = genes.of.interest)
  Idents(cond.object) <- "sgRNA"
  cell.list <- list()
  for (gene in genes.of.interest) {
    cell.list[[gene]] <- WhichCells(cond.object, idents = gene)
  }

  plot <- DimPlot(object = cond.object, group.by = 'Phase', pt.size = 1, 
                  reduction = "ldaumap", ncol = 1, cells = unlist(cell.list))
  plot1 <- DimPlot(object = cond.object, group.by = 'sgRNA', pt.size = 1, 
                   reduction = "ldaumap", ncol = 1,
                   label = TRUE, label.box = TRUE, label.color = "white",
                   cells.highlight = cell.list[!names(cell.list) %in% c("non-targeting")], 
                   cols.highlight = c(dark2_colors), cells = unlist(cell.list)) + ggtitle(sprintf("Selected Perturbations under %s Conditions", condition)) + theme(legend.position = "none")
  ggsave(
    sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/mixscape_prtb_LDAumap_%s_goiHighlight_withCycle.png", condition), 
    plot | plot1, width = 20, height = 15, limitsize = FALSE)
  
  ggsave(
    sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/mixscape_prtb_LDAumap_%s_goiHighlight.png", condition), 
    plot1, width = 10, height = 10, limitsize = FALSE)
}
```

## Investigating Prkdc heterogeneity

We're going to start over, but this time examine Prkdc and its constituent markers. Some parameters that we're choosing to keep:

-   Dims are 1:30

-   Resolution for clusters is currently held at 1.0

```{r}
data <- readRDS(PATH_TO_SEURAT_OBJECT)
data <- subset(data, sgRNA %in% c("PRKDC", "non-targeting"))

DefaultAssay(object = data) <- "RNA"
data <- SCTransform(data, vars.to.regress = NULL)

data <- RunPCA(object = data)
elbow.plot <- ElbowPlot(data, ndims = 50) + ggtitle("50 PCs, Before CC Regression")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/elbow_50_PCs.pdf", elbow.plot, width = 10, height = 10)
```

Find neighbors and clusters, and plot them together with condition and PRKDC highlighting.

```{r}
data <- FindNeighbors(data, dims = 1:30)
data <- FindClusters(data, resolution = 1.0)
data <- RunUMAP(object = data, dims = 1:30)
plot1 <- DimPlot(data, reduction = "umap", group.by = "seurat_clusters", pt.size = 0.5)
plot2 <- DimPlot(data, reduction = "umap", group.by = "cond", pt.size = 0.5)

Idents(data) <- "sgRNA"
prkdc.cells = WhichCells(cond.object, idents = "PRKDC")
plot3 <- DimPlot(data, reduction = "umap", group.by = "sgRNA", 
        cells.highlight = list("PRKDC" = prkdc.cells), pt.size = 0.5)
combined.plot <- (plot1 | plot2 | plot3) + plot_annotation(title = "Clusters at 1.0 res before cell cycle regression")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cluster_scatter_before_cc_regression_1.0.pdf", combined.plot, width = 27, height = 9)
```

Find markers for these clusters

```{r}
Idents(data) <- "seurat_clusters"
data.markers <- FindAllMarkers(data,
                               only.pos = TRUE,
                               min.pct = 0.25,
                               thresh.use = 0.25)
top10.sub <- data.markers %>% group_by(cluster) %>% top_n(10, avg_log2FC)
top25.sub <- data.markers %>% group_by(cluster) %>% top_n(25, avg_log2FC)
top25.sub$gene.symbol <- gsub("GRCh38-", "", top25.sub$gene)
write.table(top25.sub, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/pheno_top25markers_res_1.0_before_cc_regression.txt",row.names=FALSE,col.names=TRUE,sep='\t',quote=FALSE)

plot <- DoHeatmap(subset(data, downsample = 200), features = top10.sub$gene, size = 3) + NoLegend()
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cluster_heatmap_top10_markers_res_1.0_before_cc_regression.pdf", plot, width = 12, height = 30)
```

Submit the top 25 genes for clusters that we're interested in to Enrichr.

```{r}
clusters.of.interest <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
for (seurat_cluster in clusters.of.interest) {
  df.sub <- subset(top25.sub, cluster == seurat_cluster)
  dbs <- c("MSigDB_Hallmark_2020","KEGG_2021_Human",
           "WikiPathway_2021_Human","GO_Biological_Process_2021")
  goi <- df.sub$gene.symbol
  enrichROut <- enrichr(goi, dbs)
  msigDB.terms <- enrichROut$MSigDB_Hallmark_2020
  GO.terms <- enrichROut$GO_Biological_Process_2021
  write.table(msigDB.terms, file = sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/enrichr_outputs/msigdb_terms_%d_before_cc_regression.txt", seurat_cluster))
  write.table(GO.terms, file = sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/enrichr_outputs/go_terms_%d_before_cc_regression.txt", seurat_cluster))
  Sys.sleep(3)
}
```

Save the R object so we don't have to do the clustering every time

```{r}
saveRDS(data, file = "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/before_cell_cycle_regression_seurat_res1.0.rds")
```

How well do the clusters actually separate out our four conditions of Prkdc_RT, Prkdc_noRT, nt_RT, and nt_noRT?

```{r}
table_counts <- table(data$seurat_clusters, data$sgRNACond)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Cluster", "sgRNACond", "Count")
df$Total <- ave(df$Count, df$Cluster, FUN = sum)
df$Proportion <- df$Count / df$Total

proportion.plot <- ggplot(df, aes(x = Cluster, y = Proportion, fill = sgRNACond)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of sgRNACond across Clusters") +
  theme_minimal()

counts.plot <- ggplot(df, aes(x = Cluster, y = Count, fill = sgRNACond)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(y = "Count", title = "Counts of sgRNACond across Clusters") +
  theme_minimal()

ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/sgRNACond_proportion_per_cluster.png", proportion.plot, width = 15, height = 15
)
ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/counts_plot.png", counts.plot, width = 15, height = 15
)

df <- as.data.frame(as.table(t(table_counts)))
colnames(df) <- c("sgRNACond", "Cluster", "Count")
df$Total <- ave(df$Count, df$sgRNACond, FUN = sum)
df$Proportion <- df$Count / df$Total

proportion.plot <- ggplot(df, aes(x = sgRNACond, y = Proportion, fill = Cluster)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of sgRNACond across Clusters") +
  theme_minimal()
counts.plot <- ggplot(df, aes(x = sgRNACond, y = Count, fill = Cluster)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(y = "Count", title = "Counts of sgRNACond across Clusters") +
  theme_minimal()

ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/cluster_proportion_per_sgRNACond.png", proportion.plot, width = 15, height = 15
)
ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/cluster_counts_per_sgRNACond.png", counts.plot, width = 15, height = 15
)
```

We're also interested in examining a number of genes closely

```{r}
genes.of.interest <- c("CCL2", "VIM", "HSP90B1", "CCND1", "RPLP1", "RPL4")
genes.of.interest <- paste0("GRCh38-", genes.of.interest)

vln.plot <- VlnPlot(data, features = genes.of.interest)
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/goi_plots/goi_vln_plot.png", vln.plot, width = 10, height = 10)

vln.plot <- VlnPlot(data, features = genes.of.interest, slot = "counts")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/goi_plots/goi_vln_plot_counts.png", vln.plot, width = 10, height = 10)

feature.plot <- FeaturePlot(data, features = genes.of.interest)
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/goi_plots/goi_feature_plot.png", feature.plot, width = 10, height = 10)
```

Now one potential concern is that a lot of this heterogeneity comes from cell cycle markers. Let's take a look at how well cell cycle stuff lines up:

```{r}
s.genes <- paste("GRCh38-", cc.genes$s.genes, sep = "")
g2m.genes <- paste("GRCh38-", cc.genes$g2m.genes, sep = "")
data <- CellCycleScoring(data, s.features = s.genes, g2m.features = g2m.genes, set.ident = FALSE)
Idents(data) <- "Phase"
plot <- DimPlot(object = data, group.by = 'Phase', reduction = "umap", label = TRUE, label.box = TRUE, label.color = "white")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/phase_on_umap_scatter.png", plot, width = 8, height = 8)
data.cc.pca <- RunPCA(data, features = c(s.genes, g2m.genes))
DimPlot(data.cc.pca, reduction = "pca")
```

It's evident that there's a fair amount of heterogeneity due to cell cycle scoring. Let's take this out as we look purely at Prkdc heterogeneity.

```{r}
DefaultAssay(object = data) <- "RNA"
data <- SCTransform(data, vars.to.regress = c("S.Score", "G2M.Score"))
data.cc.pca <- RunPCA(data, features = c(s.genes, g2m.genes))
DimPlot(data.cc.pca, reduction = "pca")
```

Now, we can be more sure that we've taken out this source of variation.

```{r}
data <- RunPCA(object = data)
ElbowPlot(data, ndims = 50)
data <- FindNeighbors(data, dims = 1:30)
data <- FindClusters(data, resolution = 1.0)
data <- RunUMAP(object = data, dims = 1:30)
plot1 <- DimPlot(data, reduction = "umap", group.by = "seurat_clusters", pt.size = 0.5)
plot2 <- DimPlot(data, reduction = "umap", group.by = "cond", pt.size = 0.5)

Idents(data) <- "sgRNA"
prkdc.cells = WhichCells(cond.object, idents = "PRKDC")
plot3 <- DimPlot(data, reduction = "umap", group.by = "sgRNA", 
        cells.highlight = list("PRKDC" = prkdc.cells), pt.size = 0.5)
combined.plot <- (plot1 | plot2 | plot3) + plot_annotation(title = "Clusters at 1.0 res before cell cycle regression")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/cluster_cond_highlights_cell_cycle_regressed_1.0.pdf", combined.plot, width = 27, height = 9)
```

We can find markers again

```{r}
Idents(data) <- "seurat_clusters"
data.markers <- FindAllMarkers(data,
                               only.pos = TRUE,
                               min.pct = 0.25,
                               thresh.use = 0.25)
top10.sub <- data.markers %>% group_by(cluster) %>% top_n(10, avg_log2FC)
top25.sub <- data.markers %>% group_by(cluster) %>% top_n(25, avg_log2FC)
top25.sub$gene.symbol <- gsub("GRCh38-", "", top25.sub$gene)
write.table(top25.sub, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/pheno_top25markers_res_sub_1.0_cell_cycle_regressed.txt",row.names=FALSE,col.names=TRUE,sep='\t',quote=FALSE)

plot <- DoHeatmap(subset(data, downsample = 200), features = top10.sub$gene, size = 3) + NoLegend()
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/cluster_heatmap_top10_markers_res_1.0_cc_regressed.pdf", plot, width = 12, height = 30)
```

Once again, submit to Enrichr:

```{r}
clusters.of.interest <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
for (seurat_cluster in clusters.of.interest) {
  df.sub <- subset(top25.sub, cluster == seurat_cluster)
  dbs <- c("MSigDB_Hallmark_2020","KEGG_2021_Human",
           "WikiPathway_2021_Human","GO_Biological_Process_2021")
  goi <- df.sub$gene.symbol
  enrichROut <- enrichr(goi, dbs)
  msigDB.terms <- enrichROut$MSigDB_Hallmark_2020
  GO.terms <- enrichROut$GO_Biological_Process_2021
  write.table(msigDB.terms, file = sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/enrichr_outputs/msigdb_terms_%d.txt", seurat_cluster))
  write.table(GO.terms, file = sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/enrichr_outputs/go_terms_%d.txt", seurat_cluster))
  Sys.sleep(3)
}
```

And plot the clusters:

```{r}
table_counts <- table(data$seurat_clusters, data$sgRNACond)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Cluster", "sgRNACond", "Count")
df$Total <- ave(df$Count, df$Cluster, FUN = sum)
df$Proportion <- df$Count / df$Total

proportion.plot <- ggplot(df, aes(x = Cluster, y = Proportion, fill = sgRNACond)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of sgRNACond across Clusters") +
  theme_minimal()

counts.plot <- ggplot(df, aes(x = Cluster, y = Count, fill = sgRNACond)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(y = "Count", title = "Counts of sgRNACond across Clusters") +
  theme_minimal()

ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/sgRNACond_proportion_per_cluster.png", proportion.plot, width = 15, height = 15
)
ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/counts_plot.png", counts.plot, width = 15, height = 15
)

df <- as.data.frame(as.table(t(table_counts)))
colnames(df) <- c("sgRNACond", "Cluster", "Count")
df$Total <- ave(df$Count, df$sgRNACond, FUN = sum)
df$Proportion <- df$Count / df$Total

proportion.plot <- ggplot(df, aes(x = sgRNACond, y = Proportion, fill = Cluster)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of sgRNACond across Clusters") +
  theme_minimal()
counts.plot <- ggplot(df, aes(x = sgRNACond, y = Count, fill = Cluster)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(y = "Count", title = "Counts of sgRNACond across Clusters") +
  theme_minimal()

ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/cluster_proportion_per_sgRNACond.png", proportion.plot, width = 15, height = 15
)
ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/cluster_counts_per_sgRNACond.png", counts.plot, width = 15, height = 15
)
```

Plot those same genes of interest

```{r}
genes.of.interest <- c("CCL2", "VIM", "HSP90B1", "CCND1", "RPLP1", "RPL4")
genes.of.interest <- paste0("GRCh38-", genes.of.interest)

vln.plot <- VlnPlot(data, features = genes.of.interest)
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/goi_plots/goi_vln_plot.png", vln.plot, width = 10, height = 10)

vln.plot <- VlnPlot(data, features = genes.of.interest, slot = "counts")
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/goi_plots/goi_vln_plot_counts.png", vln.plot, width = 10, height = 10)

feature.plot <- FeaturePlot(data, features = genes.of.interest)
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/goi_plots/goi_feature_plot.png", feature.plot, width = 10, height = 10)
```

Save the Seurat object

```{r}
saveRDS(data, file = "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed_seruat_res1.0.rds")
```

Examine specific clusters inside the cell-cycle regressed Prkdc analysis. Since 0 and 5 are clustered together and 3 is all the way on the far side of the UMAP, let's take a look at these clusters first.

One thing we can do is look at DESeq in each cluster. Let's set up the DESeq function first.

```{r}
library(DElegate)

find_deseq_differential_genes = function(data.obj, seed, group1, group2, group_column=NULL) {
  # Takes in a normalized Seurat object with metadata
  # indicating group1 and group2 and a group_column argument
  # indicating the metadata column to be used. Sets a seed, then
  # finds differential expressed genes and outputs a data frame.
  # Note that log fold comparisons will be output as log2(group1/group2)
  set.seed(seed)
  
  # Set futures to greater than max capacity; you may need to tweak this
  options(future.globals.maxSize = 5000 * 1024^2)
  
  df = findDE(object = data.obj, group_column = group_column,
               compare = c(group1, group2), method = 'deseq')
  return(df)
}
```

Then let's run DESeq for each of our clusters.

```{r}
for (cluster in c(0, 3, 5)) {
  data.sub <- subset(data, seurat_clusters %in% c(cluster))
  de.df <- find_deseq_differential_genes(data.sub, 5000, "PRKDC_RT", "non-targeting_RT", group_column = "sgRNACond")
  file.name = sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/deseq_outputs/PRKDC_RT_non-targeting_RT_cluster_%d.csv", cluster)
  write.table(de.df, file = file.name)
}
```

With this DESeq output in hand, we can run GSEA to see what gene sets are enriched.

First, import the CSVs we generated from DESeq.

```{r}
INPUT_DIRS = "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/deseq_outputs"
data.list <- list()
for (dir in INPUT_DIRS) {
  file_names <- list.files(dir)
  for (i in file_names) {
    name <- gsub(".csv", "", i)
    df <- read.table(paste(dir, "/", i, sep = ""))
    data.list[[name]] <- df
  }
}
```

Then create a ranked gene set list for each item in data.list, removing the GRCh38- prefix from all human genes and removing any genes that have an NA LFC. We also change from gene symbol to ENSEMBL gene ID and remove unmappable symbols, averaging out the LFCs for multiple symbols that map to the same ENSEMBL gene ID.

```{r}
library(msigdbr)
library(fgsea)

ranked_gene_set_list <- list()
for (name in names(data.list)) {
  cat("Processing", name, "\n")
  
  deseq_table <- data.list[[name]]
  deseq_table$feature <- gsub("GRCh38-", "", deseq_table$feature)
  mapping <- mapIds(org.Hs.eg.db, keys = deseq_table$feature,
                      column = "ENSEMBL", keytype = "SYMBOL")
  deseq_table$ensembl <- unlist(mapping)
  deseq_table <- subset(deseq_table, !is.na(deseq_table$ensembl))
  deseq_table <- deseq_table[!is.na(deseq_table$log_fc), ]
  
  # Group by unique ensembl ID and average
  deseq_table <- deseq_table %>%
    group_by(ensembl) %>%
    summarize(log_fc = mean(log_fc))
  deseq_table <- deseq_table[order(-deseq_table$log_fc), ]
  
  # Generate a ranked list
  gene_list <- deseq_table$log_fc
  gene_names <- deseq_table$ensembl
  names(gene_list) <- gene_names
  ranked_gene_set_list[[name]] <- gene_list
}
```

Run GSEA using fgsea.

```{r}
msigdbr_df <- msigdbr(species = "Homo sapiens", category = "H")
msigdbr_list = split(x = msigdbr_df$ensembl_gene, f = msigdbr_df$gs_name)

fgsea.output.list <- list()
for (name in names(ranked_gene_set_list)) {
  gsea_results <- fgsea(pathways = msigdbr_list, stats = ranked_gene_set_list[[name]],
                        maxSize = 500, eps = 0.0) # allow arbitrarily low p-values
  fgsea.output.list[[name]] <- gsea_results
}
saveRDS(fgsea.output.list, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/fgsea_output_list.rds")
```

Examine the fgsea results.

```{r}
for (name in names(fgsea.output.list)) {
  fgseaRes <- fgsea.output.list[[name]]
  topPathwaysUp<- fgseaRes[fgseaRes$ES > 0, ][order(fgseaRes[fgseaRes$ES > 0, ]$NES, 
                                                    decreasing = TRUE)[1:10], "pathway"]
  topPathwaysDown <- fgseaRes[fgseaRes$ES < 0, ][order(fgseaRes[fgseaRes$ES < 0, ]$NES)[1:10],
                                                 "pathway"]
  topPathways <- unlist(c(topPathwaysUp, rev(topPathwaysDown)))
  plot <- plotGseaTable(msigdbr_list[topPathways], ranked_gene_set_list[[name]],
                fgseaRes, gseaParam=0.5)
  ggsave(sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cell_cycle_regressed/gsea_outputs/%s_gsea.png", name),
         plot, width = 10, height = 10)
}
```

We can also just straight up look at DESeq, but filter some items out.

```{r}
filtered.list <- list()
for (name in names(data.list)) {
  df <- data.list[[name]]
  df <- subset(df, !is.na(padj))
  df <- subset(df, pvalue < 0.05 & abs(log_fc) > 0.5)
  filtered.list[[name]] <- df
}
```

Export the script

```{r}
knitr::purl("/raleighlab/data1/czou/gbm_perturb/gbm_perturb/R/exploration/heterogeneity.Rmd", output = "/raleighlab/data1/czou/gbm_perturb/gbm_perturb/R/exploration/heterogeneity.R")
```
