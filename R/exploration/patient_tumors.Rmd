# Investigating the patient tumors

Imports and setting libpaths:

```{r}
# Set libpaths
.libPaths(c("/raleighlab/data1/czou/gbm_perturb/gbm_perturb/renv/library/R-4.3/x86_64-pc-linux-gnu", .libPaths()))

library(Seurat)
library(knitr)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(patchwork)
library(EnhancedVolcano)
```

Import the patient tumor Seurat object:

```{r}
PATIENT.SEURAT.PATH <- "/raleighlab/data1/liuj/external_data/diaz_86_gbms/Glioblastoma_R_object.rds"
data <- readRDS(PATIENT.SEURAT.PATH)
data <- UpdateSeuratObject(data)
```

Update the patient Seurat object with metadata relating to primary/recurrent tumors

```{r}
supp.table <- read.table("/raleighlab/data1/czou/gbm_perturb/data/gbm_patient_tumors/sample_to_tumor_type.csv", sep = ",")
rownames(supp.table) <- supp.table$V1
colnames(supp.table) <- c("Sample", "Recurrence")
data$recurrence <- supp.table[data$sample, "Recurrence"]
```

## Out of the box

First, let's look at how these things stack up on the UMAP:

```{r}
data.small <- subset(data, downsample = 1000)
recurrence.plot <- DimPlot(data.small, reduction = "umap", group.by = "recurrence")
cluster.plot <- DimPlot(data.small, reduction = "umap")
malignant.plot <- DimPlot(data.small, reduction = "umap", group.by = "TumorNormal")

ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/default_recurrence_cluster_tumorNormal.png", recurrence.plot | cluster.plot | malignant.plot, height = 10, width = 22)
```

Can we isolate any tumor vs. normal relationships for the existing clusters?

```{r}
table_counts <- table(data$seurat_clusters, data$TumorNormal)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Cluster", "TumorNormal", "Count")
df$Total <- ave(df$Count, df$Cluster, FUN = sum)
df$Proportion <- df$Count / df$Total
tumorNormal.plot <- ggplot(df, aes(x = Cluster, y = Proportion, fill = TumorNormal)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of tumor/normal across clusters") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1))

table_counts <- table(data$seurat_clusters, data$recurrence)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Cluster", "Recurrence", "Count")
df$Total <- ave(df$Count, df$Cluster, FUN = sum)
df$Proportion <- df$Count / df$Total
recurrence.plot <- ggplot(df, aes(x = Cluster, y = Proportion, fill = Recurrence)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of primary/recurrent across clusters") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/tumor_and_recurrence_proportion_across_clusters.png", tumorNormal.plot / recurrence.plot, height = 15, width = 25)
```

Off of these proportions, the clusters that we're interested in straight out of the box are:

-   11 (primarily recurrent tumor)

-   0 (primarily primary tumor)

-   4, 5, 6, 7, and 9 we might expect to all cluster close together - these are all half and half-ish primary vs. recurrent

What are the markers for these clusters? This could lead to a very basic understanding of what's happening.

```{r}
data.sub <- subset(data, seurat_clusters %in% c(0, 11, 4, 5, 6, 7, 9))
data.markers <- FindAllMarkers(data.sub,
                               only.pos = TRUE,
                               min.pct = 0.25,
                               thresh.use = 0.25)
top10.sub <- data.markers %>% group_by(cluster) %>% top_n(10, avg_log2FC)
top25.sub <- data.markers %>% group_by(cluster) %>% top_n(25, avg_log2FC)
write.table(top25.sub, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/pheno_top25markers_res_before_cc_regression.txt",row.names=FALSE,col.names=TRUE,sep='\t',quote=FALSE)
```

In particular, what're the differences between the mainly recurrent and the mainly primary tumor?

```{r}
primary.vs.recurrent.markers <- FindMarkers(data.sub, ident.1 = 0, ident.2 = 11, min.pct = 0.25)
write.table(primary.vs.recurrent.markers, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/primary_vs_recurrent_markers.txt",row.names=TRUE,col.names=TRUE,sep='\t',quote=FALSE)
recurrent.vs.primary.markers <- FindMarkers(data.sub, ident.1 = 11, ident.2 = 0, min.pct = 0.25)
write.table(recurrent.vs.primary.markers, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/recurrent_vs_primary_markers.txt",row.names=TRUE,col.names=TRUE,sep='\t',quote=FALSE)

down <- subset(recurrent.vs.primary.markers, avg_log2FC < 0)

write.table(rownames(down), "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/recurrent_vs_primary_markergenes_down.txt", quote = FALSE, row.names = FALSE)
```

We have done *in vivo* perturb-seq experiments with various knockouts. We're interested in how knocking out PRKDC affects various genes. How do these genes function in these patient tumors?

Get the differential expressed genes for PRKDC. How do they behave in our patient tumors? Are they part of these marker groups at all?

```{r}
# Genes for PRKDC_noRT
prkdc.noRT.deseq <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_clean_outputs/deseq/noRTNormalized/PRKDC_noRT_non-targeting_noRT.csv")

prkdc.noRT.deseq <- subset(prkdc.noRT.deseq, pvalue < 0.05 & abs(log_fc) > 0.5)
prkdc.noRT.deseq$feature <- gsub("GRCh38-", "", prkdc.noRT.deseq$feature)

# Genes for PRKDC_RT
prkdc.RT.deseq <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_clean_outputs/deseq/noRTNormalized/PRKDC_RT_non-targeting_noRT.csv")

prkdc.RT.deseq <- subset(prkdc.RT.deseq, pvalue < 0.05 & abs(log_fc) > 0.5)
prkdc.RT.deseq$feature <- gsub("GRCh38-", "", prkdc.RT.deseq$feature)

# Genes for PRKDC_RT, but normalized to PRKDC_noRT. This should be the "additional" PRKDC phenotype from being in the presence of radiation + PRKDC
prkdc.RT.deseq.condNormalized <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_clean_outputs/deseq/condNormalized/PRKDC_RT_non-targeting_RT.csv")

prkdc.RT.deseq.condNormalized <- subset(prkdc.RT.deseq.condNormalized, 
                                        pvalue < 0.05 & abs(log_fc) > 0.5)
prkdc.RT.deseq.condNormalized$feature <- gsub("GRCh38-", "", 
                                              prkdc.RT.deseq.condNormalized$feature)
gene.list <- list()
gene.list[["prkdc_noRT_noRTNormalized"]] <- prkdc.noRT.deseq$feature
gene.list[["prkdc_RT_noRTNormalized"]] <- prkdc.RT.deseq$feature
gene.list[["prkdc_RT_condNormalized"]] <- prkdc.RT.deseq.condNormalized$feature
```

Now let's look for overlaps. We have a couple of places to look for overlaps:

-   The genes that characterize recurrent as opposed to primary.

-   The different genes for our different clusters.

```{r}
rows <- list()
for (name in names(gene.list)) {
  genes <- gene.list[[name]]
  
  # Overlap with recurrent as opposed to primary
  overlap.with.recurrent.genes <- intersect(genes, rownames(recurrent.vs.primary.markers))
  write.table(overlap.with.recurrent.genes,
              sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/%s_%s.txt", name, "recurrent"), quote = FALSE, row.names = FALSE)
  
  overlap.with.recurrent <- length(overlap.with.recurrent.genes)
  
  # Overlaps with the specific cluster markers compared to others
  overlaps.with.clusters <- list()
  for (idx in c(0, 11, 4, 5, 6, 7, 9)) {
    markers <- subset(top25.sub, cluster == idx)
    overlap.genes <- intersect(genes, markers$gene)
      write.table(overlap.genes,
              sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/%s_%d.txt", name, idx), quote = FALSE, row.names = FALSE)
    overlap <- length(overlap.genes)
    overlaps.with.clusters[[as.character(idx)]] <- overlap
  }
  
  row <- c(
    exp_condition = name,
    recurrent = overlap.with.recurrent,
    overlap.0 = overlaps.with.clusters[["0"]],
    overlap.11 = overlaps.with.clusters[["11"]],
    overlap.4 = overlaps.with.clusters[["4"]],
    overlap.5 = overlaps.with.clusters[["5"]],
    overlap.6 = overlaps.with.clusters[["6"]],
    overlap.7 = overlaps.with.clusters[["7"]],
    overlap.9 = overlaps.with.clusters[["9"]]
  )
  rows[[name]] <- row
}
df <- as.data.frame(do.call(cbind, rows))
write.table(df, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps.txt", sep='\t', quote=FALSE)
```

Sweet! There's some overlaps. Let's take a look at a couple in particular:

-   PRKDC_RT_noRTNormalized with the recurrent markers, with cluster 11, and with cluster 7

-   PRKDC_RT_condNormalized with the recurrent markers

-   Let's take a look at PRKDC_noRT_noRTNormalized with the recurrent markers too. What's the best way to look at these?

Probably make volcano plots with said genes of interest. What's the correlation when it comes to log fold changes between the two groups? First, let's look at recurrent over primary vs. PRKDC_RT_noRTNormalized.

```{r}
goi <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_RT_noRTNormalized_recurrent.txt")$V1[-1]

plot1 <- EnhancedVolcano(
    recurrent.vs.primary.markers,
    lab = rownames(recurrent.vs.primary.markers),
    x = "avg_log2FC",
    y = "p_val",
    xlab = bquote(~Log[2]~ 'fold change'),
    ylim = rev(-log(range(recurrent.vs.primary.markers$p_val, na.rm = TRUE), 10)),
    title = "Recurrent vs. Primary Markers",
    subtitle = "p < 0.05 and |log_fc| > 0.5",
    selectLab = goi,
    pCutoff = 0.05,
    FCcutoff = 0.5,
    pointSize = 2.0,
    labSize = 3.0,
    colAlpha = 1,
    col = c("gray50", "gray50", "gray50", "red3"),
    legendPosition = "right",
    gridlines.major = FALSE,
    gridlines.minor = FALSE,
    cutoffLineType = "blank",
    vline = 0,
    hline = 0.05,
    legendLabSize = 6,
    legendIconSize = 2.0,
    drawConnectors = TRUE,
    max.overlaps = 40,
    widthConnectors = 0.25,
    arrowheads = FALSE
)

plot2 <- EnhancedVolcano(
    prkdc.RT.deseq,
    lab = prkdc.RT.deseq$feature,
    x = "log_fc",
    y = "pvalue",
    xlab = bquote(~Log[2]~ 'fold change'),
    ylim = rev(-log(range(prkdc.RT.deseq$pvalue, na.rm = TRUE), 10)),
    title = "PRKDC_RT_noRTNormalized DESeq",
    subtitle = "p < 0.05 and |log_fc| > 0.5",
    selectLab = goi,
    pCutoff = 0.05,
    FCcutoff = 0.5,
    pointSize = 2.0,
    labSize = 3.0,
    colAlpha = 1,
    col = c("gray50", "gray50", "gray50", "red3"),
    legendPosition = "right",
    gridlines.major = FALSE,
    gridlines.minor = FALSE,
    cutoffLineType = "blank",
    vline = 0,
    hline = 0.05,
    legendLabSize = 6,
    legendIconSize = 2.0,
    drawConnectors = TRUE,
    max.overlaps = 40,
    widthConnectors = 0.25,
    arrowheads = FALSE
  )
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_RT_noRTNormalized_recurrent_volcano.png", plot1 / plot2, height = 10, width = 20)

# What is the correlation between these guys?
patient.df <- recurrent.vs.primary.markers[goi, ]
patient.df$feature <- rownames(patient.df)
exp.df <- subset(prkdc.RT.deseq, feature %in% goi)
combined.df <- merge(patient.df, exp.df, on = "feature")
combined.df <- combined.df %>% select(feature, avg_log2FC, log_fc)
cor_coeff <- cor(combined.df$avg_log2FC, combined.df$log_fc)

scatter.plot <- ggplot(combined.df, aes(x = avg_log2FC, y = log_fc)) +
  geom_point() +
  geom_text_repel(size = 3, aes(label = feature), box.padding = 0.25, point.padding = 0.25, segment.color = "grey50", max.overlaps = 25) +
  # geom_abline(intercept = 0, slope = 1, linetype="dashed", color="lightblue") +
  # geom_smooth(method = "lm", se = FALSE, color="lightblue") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  annotate("text", x = min(combined.df$avg_log2FC), 
           y = max(combined.df$log_fc), 
           label = sprintf("r = %.2f", cor_coeff), hjust=0, vjust=1) +
  labs(x = "Patient Recurrence against Primary LFC", y = "DESeq LFC", title = "PRKDC RT noRTNormalized DE Genes vs. Recurrent Gene Markers") +
  theme(
    axis.line.x = element_line(colour = "black", linetype=1),
    axis.line.y = element_line(colour = "black", linetype=1),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_RT_noRTNormalized_recurrent_scatter.png", scatter.plot, height = 10, width = 10)
```

Then, let's take a look at PRKDC_RT_condNormalized vs. recurrent

```{r}
goi <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_RT_condNormalized_recurrent.txt")$V1[-1]

plot1 <- EnhancedVolcano(
    recurrent.vs.primary.markers,
    lab = rownames(recurrent.vs.primary.markers),
    x = "avg_log2FC",
    y = "p_val",
    xlab = bquote(~Log[2]~ 'fold change'),
    ylim = rev(-log(range(recurrent.vs.primary.markers$p_val, na.rm = TRUE), 10)),
    title = "Recurrent vs. Primary Markers",
    subtitle = "p < 0.05 and |log_fc| > 0.5",
    selectLab = goi,
    pCutoff = 0.05,
    FCcutoff = 0.5,
    pointSize = 2.0,
    labSize = 3.0,
    colAlpha = 1,
    col = c("gray50", "gray50", "gray50", "red3"),
    legendPosition = "right",
    gridlines.major = FALSE,
    gridlines.minor = FALSE,
    cutoffLineType = "blank",
    vline = 0,
    hline = 0.05,
    legendLabSize = 6,
    legendIconSize = 2.0,
    drawConnectors = TRUE,
    max.overlaps = 40,
    widthConnectors = 0.25,
    arrowheads = FALSE
)

plot2 <- EnhancedVolcano(
    prkdc.RT.deseq.condNormalized,
    lab = prkdc.RT.deseq.condNormalized$feature,
    x = "log_fc",
    y = "pvalue",
    xlab = bquote(~Log[2]~ 'fold change'),
    ylim = rev(-log(range(prkdc.RT.deseq.condNormalized$pvalue, na.rm = TRUE), 10)),
    title = "PRKDC_RT_condNormalized DESeq",
    subtitle = "p < 0.05 and |log_fc| > 0.5",
    selectLab = goi,
    pCutoff = 0.05,
    FCcutoff = 0.5,
    pointSize = 2.0,
    labSize = 3.0,
    colAlpha = 1,
    col = c("gray50", "gray50", "gray50", "red3"),
    legendPosition = "right",
    gridlines.major = FALSE,
    gridlines.minor = FALSE,
    cutoffLineType = "blank",
    vline = 0,
    hline = 0.05,
    legendLabSize = 6,
    legendIconSize = 2.0,
    drawConnectors = TRUE,
    max.overlaps = 40,
    widthConnectors = 0.25,
    arrowheads = FALSE
  )
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_RT_condNormalized_recurrent_volcano.png", plot1 / plot2, height = 10, width = 20)

# What is the correlation between these guys?
patient.df <- recurrent.vs.primary.markers[goi, ]
patient.df$feature <- rownames(patient.df)
exp.df <- subset(prkdc.RT.deseq.condNormalized, feature %in% goi)
combined.df <- merge(patient.df, exp.df, on = "feature")
combined.df <- combined.df %>% select(feature, avg_log2FC, log_fc)
cor_coeff <- cor(combined.df$avg_log2FC, combined.df$log_fc)

scatter.plot <- ggplot(combined.df, aes(x = avg_log2FC, y = log_fc)) +
  geom_point() +
  geom_text_repel(aes(label = feature), box.padding = 0.5, point.padding = 0.5, segment.color = "grey50", max.overlaps = 20) +
  # geom_abline(intercept = 0, slope = 1, linetype="dashed", color="lightblue") +
  # geom_smooth(method = "lm", se = FALSE, color="lightblue") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  annotate("text", x = min(combined.df$avg_log2FC), 
           y = max(combined.df$log_fc), 
           label = sprintf("r = %.2f", cor_coeff), hjust=0, vjust=1) +
  labs(x = "Patient Recurrence against Primary LFC", y = "DESeq LFC", title = "PRKDC RT condNormalized DE Genes vs. Recurrent Gene Markers") +
  theme(
    axis.line.x = element_line(colour = "black", linetype=1),
    axis.line.y = element_line(colour = "black", linetype=1),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_RT_condNormalized_recurrent_scatter.png", scatter.plot, height = 10, width = 10)
```

PRKDC_noRT_noRTNormalized against recurrent:

```{r}
goi <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_noRT_noRTNormalized_recurrent.txt")$V1[-1]

plot1 <- EnhancedVolcano(
    recurrent.vs.primary.markers,
    lab = rownames(recurrent.vs.primary.markers),
    x = "avg_log2FC",
    y = "p_val",
    xlab = bquote(~Log[2]~ 'fold change'),
    ylim = rev(-log(range(recurrent.vs.primary.markers$p_val, na.rm = TRUE), 10)),
    title = "Recurrent vs. Primary Markers",
    subtitle = "p < 0.05 and |log_fc| > 0.5",
    selectLab = goi,
    pCutoff = 0.05,
    FCcutoff = 0.5,
    pointSize = 2.0,
    labSize = 3.0,
    colAlpha = 1,
    col = c("gray50", "gray50", "gray50", "red3"),
    legendPosition = "right",
    gridlines.major = FALSE,
    gridlines.minor = FALSE,
    cutoffLineType = "blank",
    vline = 0,
    hline = 0.05,
    legendLabSize = 6,
    legendIconSize = 2.0,
    drawConnectors = TRUE,
    max.overlaps = 40,
    widthConnectors = 0.25,
    arrowheads = FALSE
)

plot2 <- EnhancedVolcano(
    prkdc.noRT.deseq,
    lab = prkdc.noRT.deseq$feature,
    x = "log_fc",
    y = "pvalue",
    xlab = bquote(~Log[2]~ 'fold change'),
    ylim = rev(-log(range(prkdc.noRT.deseq$pvalue, na.rm = TRUE), 10)),
    title = "PRKDC_noRT noRTNormalized DESeq",
    subtitle = "p < 0.05 and |log_fc| > 0.5",
    selectLab = goi,
    pCutoff = 0.05,
    FCcutoff = 0.5,
    pointSize = 2.0,
    labSize = 3.0,
    colAlpha = 1,
    col = c("gray50", "gray50", "gray50", "red3"),
    legendPosition = "right",
    gridlines.major = FALSE,
    gridlines.minor = FALSE,
    cutoffLineType = "blank",
    vline = 0,
    hline = 0.05,
    legendLabSize = 6,
    legendIconSize = 2.0,
    drawConnectors = TRUE,
    max.overlaps = 40,
    widthConnectors = 0.25,
    arrowheads = FALSE
  )
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_noRT_noRTNormalized_recurrent_volcano.png", plot1 / plot2, height = 10, width = 20)

# What is the correlation between these guys?
patient.df <- recurrent.vs.primary.markers[goi, ]
patient.df$feature <- rownames(patient.df)
exp.df <- subset(prkdc.noRT.deseq, feature %in% goi)
combined.df <- merge(patient.df, exp.df, on = "feature")
combined.df <- combined.df %>% select(feature, avg_log2FC, log_fc)
cor_coeff <- cor(combined.df$avg_log2FC, combined.df$log_fc)

scatter.plot <- ggplot(combined.df, aes(x = avg_log2FC, y = log_fc)) +
  geom_point() +
  geom_text_repel(aes(label = feature), box.padding = 0.5, point.padding = 0.5, segment.color = "grey50", max.overlaps = 20) +
  # geom_abline(intercept = 0, slope = 1, linetype="dashed", color="lightblue") +
  # geom_smooth(method = "lm", se = FALSE, color="lightblue") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  annotate("text", x = min(combined.df$avg_log2FC), 
           y = max(combined.df$log_fc), 
           label = sprintf("r = %.2f", cor_coeff), hjust=0, vjust=1) +
  labs(x = "Patient Recurrence against Primary LFC", y = "DESeq LFC", title = "PRKDC noRT noRTNormalized DE Genes vs. Recurrent Gene Markers") +
  theme(
    axis.line.x = element_line(colour = "black", linetype=1),
    axis.line.y = element_line(colour = "black", linetype=1),
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/overlaps/prkdc_noRT_noRTNormalized_recurrent_scatter.png", scatter.plot, height = 10, width = 10)
```

Another thing we can do is FeaturePlot some of the genes that

There's a fair amount of heterogeneity. Before we get to looking at the normal cells, let's *just* characterize the tumor cells.

## Tumor-cell only analysis

```{r}
data.tumor <- subset(data, TumorNormal == "Tumor")
```

Run a standard Seurat clustering and marker workflow. We want to see what types of things are in these tumors, and how they stack up against their origins from primary vs. recurrent patients. Recall that all recurrent patients have undergone radiation treatment.

```{r}
DefaultAssay(data.tumor) <- "RNA"
data.tumor <- SCTransform(data.tumor)
```

```{r}
data.tumor <- RunPCA(data.tumor)
ElbowPlot(data.tumor, ndims = 50)
```

```{r}
data.tumor <- FindNeighbors(data.tumor, dims = 1:30)
data.tumor <- FindClusters(data.tumor, resolution = 0.5)
data.tumor <- RunUMAP(data.tumor, dims = 1:30)
Idents(data) <- "seurat_clusters"
data.markers <- FindAllMarkers(data,
                               only.pos = TRUE,
                               min.pct = 0.25,
                               thresh.use = 0.25)
top10.sub <- data.markers %>% group_by(cluster) %>% top_n(10, avg_log2FC)
top25.sub <- data.markers %>% group_by(cluster) %>% top_n(25, avg_log2FC)
top25.sub$gene.symbol <- gsub("GRCh38-", "", top25.sub$gene)
write.table(top25.sub, "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/pheno_top25markers_res_1.0_before_cc_regression.txt",row.names=FALSE,col.names=TRUE,sep='\t',quote=FALSE)

plot <- DoHeatmap(subset(data, downsample = 200), features = top10.sub$gene, size = 3) + NoLegend()
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/cluster_heatmap_top10_markers_res_1.0_before_cc_regression.pdf", plot, width = 12, height = 30)
```

How well do the clusters, along with their markers, delineate the recurrent/non-recurrent divide?

```{r}
table_counts <- table(data$seurat_clusters, data$sgRNACond)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Cluster", "sgRNACond", "Count")
df$Total <- ave(df$Count, df$Cluster, FUN = sum)
df$Proportion <- df$Count / df$Total

proportion.plot <- ggplot(df, aes(x = Cluster, y = Proportion, fill = sgRNACond)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of sgRNACond across Clusters") +
  theme_minimal()

counts.plot <- ggplot(df, aes(x = Cluster, y = Count, fill = sgRNACond)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(y = "Count", title = "Counts of sgRNACond across Clusters") +
  theme_minimal()

ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/sgRNACond_proportion_per_cluster.png", proportion.plot, width = 15, height = 15
)
ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/counts_plot.png", counts.plot, width = 15, height = 15
)

df <- as.data.frame(as.table(t(table_counts)))
colnames(df) <- c("sgRNACond", "Cluster", "Count")
df$Total <- ave(df$Count, df$sgRNACond, FUN = sum)
df$Proportion <- df$Count / df$Total

proportion.plot <- ggplot(df, aes(x = sgRNACond, y = Proportion, fill = Cluster)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of sgRNACond across Clusters") +
  theme_minimal()
counts.plot <- ggplot(df, aes(x = sgRNACond, y = Count, fill = Cluster)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(y = "Count", title = "Counts of sgRNACond across Clusters") +
  theme_minimal()

ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/cluster_proportion_per_sgRNACond.png", proportion.plot, width = 15, height = 15
)
ggsave(
  "/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_prkdc/non_cell_cycle_regressed/cluster_counts_per_sgRNACond.png", counts.plot, width = 15, height = 15
)
```

What does this data look like? What are the different parts of it? Let's just try to get a couple basic visualizations.

```{r}
umap.plot <- DimPlot(data, reduction = 'umap')
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/umap_plot.png")
```

Ok, it turns out that we're having some serious performance issues with the number of cells we have. So we're gonna have to go fewer samples at a time. Let's take a look at which we should be most interested in (i.e. we want the ones with tumor cells).

```{r}
table_counts <- table(data$sample, data$TumorNormal)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Sample", "TumorNormal", "Count")
df$Total <- ave(df$Count, df$Sample, FUN = sum)
df$Proportion <- df$Count / df$Total
```

Graph out these samples so that we can see which are relevant

```{r}
proportion.plot <- ggplot(df, aes(x = Sample, y = Proportion, fill = TumorNormal)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of tumor/normal across samples") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/proportion_plot.png", proportion.plot, width = 20, height = 10)
```

Since we've also already run Seurat, we can take a look at the clusters in the same way:

```{r}
table_counts <- table(data$seurat_clusters, data$TumorNormal)
df <- as.data.frame(as.table(table_counts))
colnames(df) <- c("Cluster", "TumorNormal", "Count")
df$Total <- ave(df$Count, df$Cluster, FUN = sum)
df$Proportion <- df$Count / df$Total
proportion.plot <- ggplot(df, aes(x = Cluster, y = Proportion, fill = TumorNormal)) +
  geom_bar(stat = "identity") +
  labs(y = "Proportion", title = "Distribution of tumor/normal across clusters") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggsave("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/patient_tumors/tumor_normal_proportion_across_clusters.png", proportion.plot, width = 20, height = 10)
```

Uh...wait what? There's no way they're that well distributed. What's going on, and what are these clusters?

```{r}
DimPlot(data.small, reduction = 'umap', group.by = 'TumorNormal')
```
