# Investigating GL261 with LDA

Set libpaths:

```{r}
.libPaths(c("/raleighlab/data1/czou/gbm_perturb/gbm_perturb/renv/library/R-4.3/x86_64-pc-linux-gnu", .libPaths()))
```

Import libraries

```{r}
library(Seurat)
library(clusterProfiler)
library(org.Hs.eg.db)
library(knitr)
library(msigdbr)
library(fgsea)
library(dplyr)
library(data.table)
library(ggplot2)
library(grid)
library(patchwork)
library(scales)
library(reshape2)
library(SCpubr)
library(enrichR)
library(RColorBrewer)
library(EnhancedVolcano)
library(stringr)
```

Define some constants. Note that we are using the human and mouse combined reference Seurat object right now.

```{r}
CONTEXT <- "preinf"
OUTPUT.DIR <- paste("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gl261_clean_outputs/lda", CONTEXT, sep = "/")
PATH.TO.SEURAT.OBJECT <- "/raleighlab/data1/liuj/gbm_perturb/analysis/GL261_integrated_20230619.Rds"
IGNORE.GUIDES <- c("NA_RT", "NA_noRT", "non-targeting_B_RT", "non-targeting_B_noRT")
MINIMUM.COVERAGE <- 5
```

## Mixscape

Load up the R object and run basic workflow on it, removing guides we want to ignore and any that don't pass coverage filters. Note that we normalize by context, because we are primarily interested in examining the per context effects and will never plot multiple contexts in the same UMAP.

```{r}
data.combined <- readRDS(PATH.TO.SEURAT.OBJECT)
data <- subset(data.combined, source == CONTEXT)

guides = unique(data$sgRNACond)
guides <- guides[!(guides %in% IGNORE.GUIDES)]
data = subset(data, sgRNACond %in% guides)

sgRNACond_counts = table(data$sgRNACond)
data = subset(data, sgRNACond %in% 
                        names(sgRNACond_counts[sgRNACond_counts > MINIMUM.COVERAGE]))

data <- NormalizeData(object = data, assay = "RNA", normalization.method = "CLR", margin = 2)
DefaultAssay(object = data) <- "RNA"

data <- NormalizeData(object = data) %>% FindVariableFeatures() %>% ScaleData()
data <- RunPCA(object = data)

plot <- ElbowPlot(data, ndims = 50)
ggsave(paste(OUTPUT.DIR, sprintf("elbow_plot_%s.png", CONTEXT), sep = "/"), plot, width = 10,
         height = 10)
# data <- RunUMAP(object = data, dims = 1:30)
```

Take a look at how cell cycle affects where in the UMAP things end up.

```{r}
s.genes <- str_to_title(cc.genes$s.genes)
g2m.genes <- str_to_title(cc.genes$g2m.genes)
data <- CellCycleScoring(data, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

# Plot the entire set of data, split by RT
plot <- DimPlot(object = data, group.by = 'Phase', split.by = "cond", reduction = "umap", ncol = 1, pt.size = 3, label = TRUE, label.box = TRUE, label.color = "white")
plot1 <- DimPlot(object = data, group.by = 'sgRNA', split.by = "cond", reduction = "umap", ncol = 1, pt.size = 3, label = TRUE, label.box = TRUE, label.color = "white")
ggsave(paste(OUTPUT.DIR, "umap_cellcycle.png", sep = "/"), plot | plot1, width = 40, height = 20)

# Plot data for individual perturbations and show them across cell cycle
for (i in c("non-targeting", "Prkdc", "Nat2")) {
  perturb_data = subset(data, sgRNA == i)
  perturb_cells = colnames(perturb_data)
  plot <- DimPlot(object = data, group.by = 'Phase', split.by = "cond", reduction = "umap",
                  ncol = 1, pt.size = 3)
  plot1 <- DimPlot(object = data, group.by = 'sgRNA', split.by = "cond", reduction = "umap",
                   ncol = 1, cells.highlight = perturb_cells, pt.size = 3)
  ggsave(paste(OUTPUT.DIR, sprintf("umap_cellcycle_highlight_%s.png", i), sep = "/"), plot | plot1, width = 40,
         height = 20)
}
```

Calculate perturbation signals

```{r}
data <- CalcPerturbSig(
  object = data,
  assay = "RNA",
  slot = "data",
  gd.class = "sgRNA",
  nt.cell.class = "non-targeting",
  reduction = "pca",
  ndims = 30,
  num.neighbors = 15,
  new.assay.name = "PRTB",
  split.by = "cond"
)
DefaultAssay(data) <- "PRTB"

VariableFeatures(data) <- VariableFeatures(data[["RNA"]])
data <- ScaleData(data, do.scale = FALSE, do.center = TRUE)

data <- RunPCA(object = data, reduction.key = "prtbpca", reduction.name = "prtbpca")

data <- RunUMAP(
  object = data, 
  dims = 1:30, 
  reduction = 'prtbpca', 
  reduction.key = 'prtbumap', 
  reduction.name = 'prtbumap')
```

Plot the perturb-normalized UMAP

```{r}
plot <- DimPlot(object = data, group.by = 'Phase', pt.size = 2, split.by = "cond", reduction = "prtbumap", ncol = 1) 
plot1 <- DimPlot(object = data, group.by = 'sgRNA', pt.size = 2, split.by = "cond", reduction = "prtbumap", ncol = 1, label = TRUE, label.box = TRUE, label.color = "white")
ggsave(paste(OUTPUT.DIR, "umap_prtb_cellcycle.png", sep = "/"), plot | plot1, width = 40, height = 20)
```

Run Mixscape, splitting by radiation condition:

```{r}
data <- RunMixscape(
  object = data,
  assay = "PRTB",
  slot = "scale.data",
  labels = "sgRNA",
  nt.class.name = "non-targeting",
  min.de.genes = 5,
  logfc.threshold = 0.1,
  iter.num = 10,
  de.assay = "RNA",
  verbose = TRUE,
  prtb.type = "KO",
  split.by = "cond"
)

df <- table(data$mixscape_class.global, data$mixscape_class)
df2 <- reshape2::melt(df)
df2$Var2 <- as.character(df2$Var2)
test <- df2[which(df2$Var1 == "KO"),]
test <- test[order(test$value, decreasing = TRUE),]
new.levels <- test$Var2
df2$Var2 <- factor(df2$Var2, levels = new.levels )
df2$Var1 <- factor(df2$Var1, levels = c("non-targeting", "NP", "KO"))
df2$gene <- sapply(as.character(df2$Var2), function(x) strsplit(x, split = " ")[[1]][1])
df3 <- df2[-c(which(df2$gene == "non-targeting")),]

p1 <- ggplot(df3, aes(x = gene, y = value, fill= Var1)) +
  geom_bar(stat= "identity") +
  theme_classic()+
  scale_fill_manual(values = c("grey49", "grey79","coral1")) + 
  ylab("n cells") +
  xlab("sgRNA")

plot <- p1 + theme(axis.text.x = element_blank(),
           axis.text.y = element_text(size = 10), 
           axis.title = element_text(size = 8), 
           strip.text = element_text(size=8, face = "bold")) + 
  facet_wrap(vars(gene),ncol = 5, scales = "free") +
  labs(fill = "mixscape class") +theme(legend.title = element_text(size = 10),
                                       legend.text = element_text(size = 8))

ggsave(paste(OUTPUT.DIR, "umap_prtb_ncell_calls.png", sep = "/"), plot, width = 12, height = 8)
saveRDS(data, paste(OUTPUT.DIR, sprintf("%s_mixscaped_data.rds", CONTEXT), sep = "/"))
```

Inspect the Mixscape results

```{r}
perturb_plot <- PlotPerturbScore(object = data, target.gene.ident = "Ifnar1", target.gene.class = "sgRNA", mixscape.class = "mixscape_class", col = "coral2", split.by = "cond") + labs(fill = "mixscape class")
ggsave(paste(OUTPUT.DIR, "Ifnar1_perturb_plot.png", sep = "/"), perturb_plot, width = 12, height = 8)

# For remaining plots, split by RT and noRT

for (condition in c("noRT", "RT")) {
  cond_object = subset(data, cond == condition)
  vln_plot <- VlnPlot(cond_object, "mixscape_class_p_ko", idents = c("non-targeting", "Nat2 KO", "Nat2 NP")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), 
        axis.text = element_text(size = 16), 
        plot.title = element_text(size = 20)) + 
  NoLegend() +
  ggtitle("mixscape posterior probabilities")
  ggsave(sprintf("%s/nat2_vln_plot_%s.png", OUTPUT.DIR, condition), vln_plot, width = 12,
         height = 8)
  
  Idents(object = cond_object) <- "sgRNA"
  genepass <- c('Nat2','Ifnar1','Rad21')

  for (i in 1:length(genepass)) {
    plot <- MixscapeHeatmap(object = cond_object, 
                            ident.1 = "non-targeting", 
                            ident.2 = genepass[i], 
                            balanced = FALSE, 
                            assay = "RNA", 
                            max.genes = 30, angle = 0, 
                            group.by = "mixscape_class", 
                            max.cells.group = 300,
                            size=6.5) + NoLegend() + 
      theme(axis.text.y = element_text(size = 16))
      ggsave(paste(OUTPUT.DIR, "/mixscape_prtb_", genepass[i], condition,"_DEgenes.png", sep=''),
             plot, width = 15, height = 10)
  }
}
```

Run LDA

```{r}
cond_objects = list()
for (condition in c("noRT", "RT")) {
  cond_object = subset(data, cond == condition)
  cond_object <- MixscapeLDA(
    object = cond_object,
    assay = "RNA",
    pc.assay = "PRTB",
    labels = "sgRNA",
    nt.label = "non-targeting",
    npcs = 10,
    logfc.threshold = 0.1,
    verbose = TRUE
  )
  saveRDS(cond_object, file = sprintf("%s/%s_lda_data.rds", OUTPUT.DIR, condition))
}

for (condition in c("noRT", "RT")) {
  cond_object = cond_objects[[condition]]
  cond_object <- RunUMAP(
    object = cond_object,
    dims = 1:25,
    reduction = 'lda',
    min.dist = 0.05,
    reduction.key = 'ldaumap',
    reduction.name = 'ldaumap'
  )
  cond_objects[[condition]] <- cond_object
}

saveRDS(cond_objects, file = sprintf("%s/%s_lda_data_cond_objects_post_umap.rds", OUTPUT.DIR, condition))

```

Note that the CED LDA object can capture only 27 dimensions. We should probably shrink the number of dimensions to match? So I shrank the number of dims for CED to 20 for UMAP.

```{r}
for (condition in c("noRT", "RT")) {
  cond_object = cond_objects[[condition]]
  
  # plot <- DimPlot(object = cond_object, group.by = 'Phase', pt.size = 1, 
  #               reduction = "ldaumap", ncol = 1) 
  plot1 <- DimPlot(object = cond_object, group.by = 'sgRNA', pt.size = 1, 
               reduction = "ldaumap", ncol = 1,
               label = TRUE, label.box = TRUE, label.color = "white") 
  ggsave(sprintf("%s/lda/mixscape_prtb_LDAumap_%s.png", OUTPUT.DIR, condition), 
         plot1, width = 10, height = 10, limitsize = FALSE)
  
  iter = names(table(cond_object$sgRNA))
  for (i in 1:length(table(cond_object$sgRNA))){
    plot <- DimPlot(object = cond_object, group.by = 'sgRNA', 
                    pt.size = 1, reduction = "ldaumap",
                    ncol = 1,
                    cells.highlight = colnames(cond_object)[cond_object$sgRNA == iter[i]]) +
      NoLegend() + ggtitle(iter[i])
    ggsave(paste(OUTPUT.DIR, "/lda_umaps", "/mixscape_prtb_LDAumap_",
                 iter[i], condition, ".png", sep=''), plot, width = 10, height = 8)
  }

  # Make custom plot highlighting only select genes
  genepass <- c('Nat2', 'Cdkn2a', 'Ifnar1', 'non-targeting')
  cond_object$sgRNAPass <- cond_object$sgRNA
  cond_object$sgRNAPass[!(cond_object$sgRNAPass %in% genepass)] = 'Other'

  # cell cycle vs select sgRNAs
  # Set colors for each perturbation.
  col = brewer.pal(n = 4, name = "Dark2")
  col = c(col[1:2],'gray80','gray90',col[3:4])

  Idents(object = cond_object) <- "sgRNAPass"
  plot <- DimPlot(object = cond_object, group.by = 'Phase', pt.size = 3, 
                reduction = "ldaumap", ncol = 1) 
  plot1 <- DimPlot(object = cond_object, group.by = 'sgRNAPass', pt.size = 3, 
                   reduction = "ldaumap", ncol = 1) + scale_color_manual(values=col, 
                                                                         drop=FALSE) 
  ggsave(sprintf("%s/lda/mixscape_prtb_LDAumap_passgenes_%s.png", OUTPUT.DIR, condition), 
         plot | plot1, width = 30, height = 20, limitsize = FALSE)

  # cluster sgRNAs by perturbation 
  cond_object.PRTB <- AverageExpression(cond_object, assay = "PRTB", 
                                 slot = 'scale.data', group.by = "sgRNA")
  corsPRTB <- cor(as.matrix(cond_object.PRTB$PRTB))

  png(sprintf("%s/lda/heatmap_PRTB_scaledata_averageExpr_%s.png",
              OUTPUT.DIR, condition), width = 6000, height= 6000,res = 600)
  heatmap(corsPRTB)
}
```

Highlight genes we're interested in and construct an array of UMAPs for each one using scpubr.

```{r}
guides.of.interest.list <- list()
guides.of.interest.list[["RT"]] <- unique(cond_objects[["RT"]]$sgRNA)
guides.of.interest.list[["noRT"]] <- unique(cond_objects[["noRT"]]$sgRNA)

for (condition in c("noRT", "RT")) {
  cond.object <- cond_objects[[condition]]
  Idents(cond.object) <- "sgRNA"
  plot.array <- SCpubr::do_DimPlot(
    cond.object,
    reduction = "ldaumap",
    split.by = "sgRNA",
    idents.keep = guides.of.interest.list[[condition]],
    ncol = 6,
    na.value = "#F1F1F1",
    pt.size = 4,
    plot_cell_borders = FALSE
  )
  ggsave(sprintf("%s/lda/mixscape_prtb_LDAumap_%s_perturb_array.pdf", OUTPUT.DIR, condition), 
         plot.array, width = 60, height = 70, limitsize = FALSE, device = "pdf")
  
  combined.plot <- SCpubr::do_DimPlot(cond.object, group.by = 'sgRNA', 
                                      pt.size = 2, reduction = "ldaumap",
               label = TRUE, label.box = TRUE, label.size = 3, 
               label.fill = NULL, label.color = "white", plot_cell_borders = FALSE) 
  ggsave(sprintf("%s/lda/mixscape_prtb_LDAumap_%s.pdf", OUTPUT.DIR, condition), 
         combined.plot, width = 10, height = 10, limitsize = FALSE, device = "pdf")
}
```

```{r}
genes.of.interest <- c("PRKDC", "RBX1", "RPLP0", "RBM42", "POLR2C", "MED17", "non-targeting")

cond.objects <- list()
cond.objects[["noRT"]] <- cond.object.noRT
cond.objects[["RT"]] <- cond.object.RT
num_colors <- length(genes.of.interest) - 1
dark2_colors <- brewer.pal(num_colors, "Dark2")


for (condition in c("noRT", "RT")) {
  cond.object <- cond.objects[[condition]]
  cond.object$sgRNA <- factor(cond.object$sgRNA, levels = genes.of.interest)
  Idents(cond.object) <- "sgRNA"
  cell.list <- list()
  for (gene in genes.of.interest) {
    cell.list[[gene]] <- WhichCells(cond.object, idents = gene)
  }

  plot <- DimPlot(object = cond.object, group.by = 'Phase', pt.size = 1, 
                  reduction = "ldaumap", ncol = 1, cells = unlist(cell.list))
  plot1 <- DimPlot(object = cond.object, group.by = 'sgRNA', pt.size = 1, 
                   reduction = "ldaumap", ncol = 1,
                   label = TRUE, label.box = TRUE, label.color = "white",
                   cells.highlight = cell.list[!names(cell.list) %in% c("non-targeting")], 
                   cols.highlight = c(dark2_colors), cells = unlist(cell.list)) + ggtitle(sprintf("Selected Perturbations under %s Conditions", condition)) + theme(legend.position = "none")
  ggsave(
    sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/mixscape_prtb_LDAumap_%s_goiHighlight_withCycle.png", condition), 
    plot | plot1, width = 20, height = 15, limitsize = FALSE)
  
  ggsave(
    sprintf("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_gbm43_explore_outputs/heterogeneity/gbm_pdx_perturb_mixscape/lda/mixscape_prtb_LDAumap_%s_goiHighlight.png", condition), 
    plot1, width = 10, height = 10, limitsize = FALSE)
}
```

```{r}
knitr::purl("/raleighlab/data1/czou/gbm_perturb/gbm_perturb/R/exploration/gl261_mixscape_lda.Rmd", output = "/raleighlab/data1/czou/gbm_perturb/gbm_perturb/R/exploration/gl261_mixscape_lda.R")
```

Take a look at Ptprc DESeq

```{r}
sgNegCtrl_3 <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_sb28_clean_outputs/deseq/SB28_integrated_20231207_ME/sgRNA_gene_negCtrl3/Macrophages/Ptprc_sgNegCtrl_3.csv")
sgNegCtrl_all <- read.table("/raleighlab/data1/czou/gbm_perturb/gbm_perturb_sb28_clean_outputs/deseq/SB28_integrated_20231207_ME/sgRNA_gene/Macrophages/Ptprc_sgNegCtrl.csv")

sgNegCtrl_3
```

Scatter against the two log_fcs:

```{r}
plot(sgNegCtrl_3$log_fc, sgNegCtrl_all$log_fc)
```
